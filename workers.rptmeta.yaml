report:
  title: "Get Workers with Expired Licenses"
  description: "Identifies workers whose licenses have expired."
  version: 1
  tags:
    - "Compliance"
    - "Workers"
  caching:
    isCachable: true
    cacheDuration: 600
  scheduling:
    isScheduled: true
    schedule: "0 0 * * *" # Daily at midnight

variables:
  - name: "workerStatus"
    placeholder: "${workerStatus}"
    type: "string"
    default: "Active"
    description: "Status of workers to include in the report."
    isRequired: true
    allowedValues: ["Active", "Inactive"]

  - name: "sortOrder"
    placeholder: "${sortOrder}"
    type: "string"
    default: "ASC"
    description: "Sort order for the worker names (ASC or DESC)."
    isRequired: false
    allowedValues: ["ASC", "DESC"]

sql: |
  SELECT
      "w"."first_name",
      "w"."last_name",
      "wp"."license_number",
      CAST(to_timestamp("wp"."license_expiry") AS DATE) AS "license_expiry"
  FROM
      "workers" AS "w"
  LEFT JOIN "worker_profiles" AS "wp" ON "wp"."worker_id" = "w"."id"
  WHERE "w"."status" IN (${workerStatus})
    AND "wp"."license_expiry" < extract(epoch from current_timestamp)::bigint
  ORDER BY "w"."first_name" ${sortOrder};
